{"version":3,"file":"bytesCmp-36048258.js","sources":["../src/helpers/sequentialDom.ts","../src/components/ripple.ts","../src/components/button.ts","../src/helpers/textToSvgURL.ts","../src/helpers/bytes/bytesCmp.ts"],"sourcesContent":["/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport {fastRaf} from './schedulers';\nimport deferredPromise, {CancellablePromise} from './cancellablePromise';\nimport {MOUNT_CLASS_TO} from '../config/debug';\nimport isInDOM from './dom/isInDOM';\n\nclass SequentialDom {\n  private promises: Partial<{\n    read: CancellablePromise<void>,\n    write: CancellablePromise<void>\n  }> = {};\n  private raf = fastRaf.bind(null);\n  private scheduled = false;\n\n  private do(kind: keyof SequentialDom['promises'], callback?: VoidFunction) {\n    let promise = this.promises[kind];\n    if(!promise) {\n      this.scheduleFlush();\n      promise = this.promises[kind] = deferredPromise<void>();\n    }\n\n    if(callback !== undefined) {\n      promise.then(() => callback());\n    }\n\n    return promise;\n  }\n\n  public measure(callback?: VoidFunction) {\n    return this.do('read', callback);\n  }\n\n  public mutate(callback?: VoidFunction) {\n    return this.do('write', callback);\n  }\n\n  /**\n   * Will fire instantly if element is not connected\n   * @param element\n   * @param callback\n   */\n  public mutateElement(element: HTMLElement, callback?: VoidFunction) {\n    const isConnected = isInDOM(element);\n    const promise = isConnected ? this.mutate() : Promise.resolve();\n\n    if(callback !== undefined) {\n      if(!isConnected) {\n        callback();\n      } else {\n        promise.then(() => callback());\n      }\n    }\n\n    return promise;\n  }\n\n  private scheduleFlush() {\n    if(!this.scheduled) {\n      this.scheduled = true;\n\n      this.raf(() => {\n        this.promises.read && this.promises.read.resolve();\n        this.promises.write && this.promises.write.resolve();\n\n        this.scheduled = false;\n        this.promises = {};\n      });\n    }\n  }\n}\n\nconst sequentialDom = new SequentialDom();\nMOUNT_CLASS_TO && (MOUNT_CLASS_TO.sequentialDom = sequentialDom);\nexport default sequentialDom;\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport findUpClassName from '../helpers/dom/findUpClassName';\nimport sequentialDom from '../helpers/sequentialDom';\nimport IS_TOUCH_SUPPORTED from '../environment/touchSupport';\nimport rootScope from '../lib/rootScope';\nimport findUpAsChild from '../helpers/dom/findUpAsChild';\nimport {fastRaf} from '../helpers/schedulers';\nimport liteMode from '../helpers/liteMode';\n\nlet rippleClickId = 0;\nexport default function ripple(\n  elem: HTMLElement,\n  callback: (id: number) => Promise<boolean | void> = () => Promise.resolve(),\n  onEnd: (id: number) => void = null,\n  prepend = false,\n  attachListenerTo = elem\n) {\n  // return;\n  if(elem.querySelector('.c-ripple')) return;\n  elem.classList.add('rp');\n\n  const r = document.createElement('div');\n  r.classList.add('c-ripple');\n\n  const isSquare = elem.classList.contains('rp-square');\n  if(isSquare) {\n    r.classList.add('is-square');\n  }\n\n  elem[prepend ? 'prepend' : 'append'](r);\n\n  let handler: () => void;\n  // let animationEndPromise: Promise<number>;\n  const drawRipple = (clientX: number, clientY: number) => {\n    const startTime = Date.now();\n    const circle = document.createElement('div');\n\n    const clickId = rippleClickId++;\n\n    // console.log('ripple drawRipple');\n\n    // const auto = elem.classList.contains('row-sortable') && !elem.classList.contains('cant-sort');\n    const auto = false;\n    const duration = (auto ? .3 : +window.getComputedStyle(r).getPropertyValue('--ripple-duration').replace('s', '')) * 1000;\n    // console.log('ripple duration', duration);\n\n    const _handler = handler = () => {\n    // handler = () => animationEndPromise.then((duration) => {\n      // console.log('ripple animation was:', duration);\n\n      // const duration = isSquare || mediaSizes.isMobile ? 200 : 700;\n      // return;\n      const elapsedTime = Date.now() - startTime;\n      const cb = () => {\n        // console.log('ripple elapsedTime total pre-remove:', Date.now() - startTime);\n        sequentialDom.mutate(() => {\n          circle.remove();\n        });\n\n        onEnd?.(clickId);\n      };\n      if(elapsedTime < duration) {\n        const delay = Math.max(duration - elapsedTime, duration / 2);\n        setTimeout(() => circle.classList.add('hiding'), Math.max(delay - duration / 2, 0));\n\n        setTimeout(cb, delay);\n      } else {\n        circle.classList.add('hiding');\n        setTimeout(cb, duration / 2);\n      }\n\n      if(!IS_TOUCH_SUPPORTED) {\n        window.removeEventListener('contextmenu', handler);\n        window.removeEventListener('mousemove', handler);\n      }\n\n      handler = null;\n      touchStartFired = false;\n    };\n    // });\n\n    callback?.(clickId);\n\n    /* callback().then((bad) => {\n      if(bad) {\n        span.remove();\n        return;\n      } */\n\n    // console.log('ripple after promise', Date.now() - startTime);\n    // console.log('ripple tooSlow:', tooSlow);\n    /* if(tooSlow) {\n        span.remove();\n        return;\n      } */\n\n    fastRaf(() => {\n      if(_handler !== handler) {\n        return;\n      }\n\n      const rect = r.getBoundingClientRect();\n      circle.classList.add('c-ripple__circle');\n\n      const clickX = clientX - rect.left;\n      const clickY = clientY - rect.top;\n\n      const radius = Math.sqrt((Math.abs(clickY - rect.height / 2) + rect.height / 2) ** 2 + (Math.abs(clickX - rect.width / 2) + rect.width / 2) ** 2);\n      const size = radius;\n\n      // center of circle\n      const x = clickX - size / 2;\n      const y = clickY - size / 2;\n\n      // console.log('ripple click', offsetFromCenter, size, clickX, clickY);\n\n      circle.style.width = circle.style.height = size + 'px';\n      circle.style.left = x + 'px';\n      circle.style.top = y + 'px';\n\n      // нижний код выполняется с задержкой\n      /* animationEndPromise = new Promise((resolve) => {\n          span.addEventListener('animationend', () => {\n            // 713 -> 700\n            resolve(((Date.now() - startTime) / 100 | 0) * 100);\n          }, {once: true});\n        }); */\n\n      // нижний код не всегда включает анимацию ПРИ КЛИКЕ НА ТАЧПАД БЕЗ ТАПТИК ЭНЖИНА\n      /* span.style.display = 'none';\n        r.append(span);\n        duration = +window.getComputedStyle(span).getPropertyValue('animation-duration').replace('s', '') * 1000;\n        span.style.display = ''; */\n\n      r.append(circle);\n\n      if(auto) {\n        // window.addEventListener('mousemove', handler, {once: true, passive: true});\n        handler();\n      }\n\n      // r.classList.add('active');\n      // handler();\n    });\n    // });\n  };\n\n  const isRippleUnneeded = (e: Event) => {\n    return e.target !== elem && (\n      ['BUTTON', 'A'].includes((e.target as HTMLElement).tagName) ||\n        findUpClassName(e.target as HTMLElement, 'c-ripple') !== r\n    ) && (\n      attachListenerTo === elem ||\n        !findUpAsChild(e.target as HTMLElement, attachListenerTo)\n    ) && !findUpClassName(e.target, 'checkbox-field');\n  };\n\n  // TODO: rename this variable\n  let touchStartFired = false;\n  if(IS_TOUCH_SUPPORTED) {\n    const touchEnd = () => {\n      handler?.();\n    };\n\n    attachListenerTo.addEventListener('touchstart', (e) => {\n      if(!liteMode.isAvailable('animations')) {\n        return;\n      }\n\n      // console.log('ripple touchstart', e);\n      if(e.touches.length > 1 || touchStartFired || isRippleUnneeded(e)) {\n        return;\n      }\n\n      // console.log('touchstart', e);\n      touchStartFired = true;\n\n      const {clientX, clientY} = e.touches[0];\n      drawRipple(clientX, clientY);\n      attachListenerTo.addEventListener('touchend', touchEnd, {once: true});\n\n      window.addEventListener('touchmove', (e) => {\n        e.cancelBubble = true;\n        e.stopPropagation();\n        touchEnd();\n        attachListenerTo.removeEventListener('touchend', touchEnd);\n      }, {once: true});\n    }, {passive: true});\n  } else {\n    attachListenerTo.addEventListener('mousedown', (e) => {\n      if(![0, 2].includes(e.button)) { // only left and right buttons\n        return;\n      }\n\n      if(!liteMode.isAvailable('animations')) {\n        return;\n      }\n      // console.log('ripple mousedown', e, e.target, findUpClassName(e.target as HTMLElement, 'c-ripple') === r);\n\n      if(attachListenerTo.dataset.ripple === '0' || isRippleUnneeded(e)) {\n        return;\n      } else if(touchStartFired) {\n        touchStartFired = false;\n        return;\n      }\n\n      const {clientX, clientY} = e;\n      drawRipple(clientX, clientY);\n      window.addEventListener('mouseup', handler, {once: true, passive: true});\n      window.addEventListener('contextmenu', handler, {once: true, passive: true});\n    }, {passive: true});\n  }\n}\n","/*\n * https://github.com/morethanwords/tweb\n * Copyright (C) 2019-2021 Eduard Kuzmenko\n * https://github.com/morethanwords/tweb/blob/master/LICENSE\n */\n\nimport {FormatterArguments, i18n, LangPackKey} from '../lib/langPack';\nimport ripple from './ripple';\n\nexport type ButtonOptions = Partial<{\n  noRipple: true,\n  onlyMobile: true,\n  icon: string,\n  rippleSquare: true,\n  text: LangPackKey,\n  textArgs?: FormatterArguments,\n  disabled: boolean,\n  asDiv: boolean,\n  asLink: boolean\n}>;\n\nexport default function Button<T extends ButtonOptions>(className: string, options: T = {} as T): T['asLink'] extends true ? HTMLAnchorElement : HTMLButtonElement {\n  const button = document.createElement(options.asLink ? 'a' : (options.asDiv ? 'div' : 'button'));\n  button.className = className + (options.icon ? ' tgico-' + options.icon : '');\n\n  if(!options.noRipple) {\n    if(options.rippleSquare) {\n      button.classList.add('rp-square');\n    }\n\n    ripple(button);\n  }\n\n  if(options.onlyMobile) {\n    button.classList.add('only-handhelds');\n  }\n\n  if(options.disabled) {\n    button.setAttribute('disabled', 'true');\n  }\n\n  if(options.text) {\n    button.append(i18n(options.text, options.textArgs));\n  }\n\n  return button as any;\n}\n","export default function textToSvgURL(text: string) {\n  const blob = new Blob([text], {type: 'image/svg+xml;charset=utf-8'});\n\n  // * because iOS Safari doesn't want to eat objectURL\n  return new Promise<string>((resolve) => {\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      resolve(e.target.result as string);\n    };\n    reader.readAsDataURL(blob);\n  });\n  // return URL.createObjectURL(blob);\n}\n","export default function bytesCmp(bytes1: number[] | Uint8Array, bytes2: number[] | Uint8Array) {\n  const len = bytes1.length;\n  if(len !== bytes2.length) {\n    return false;\n  }\n\n  for(let i = 0; i < len; ++i) {\n    if(bytes1[i] !== bytes2[i]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n"],"names":["SequentialDom","fastRaf","kind","callback","promise","deferredPromise","element","isConnected","isInDOM","sequentialDom","MOUNT_CLASS_TO","rippleClickId","ripple","elem","onEnd","prepend","attachListenerTo","r","handler","drawRipple","clientX","clientY","startTime","circle","clickId","duration","_handler","elapsedTime","cb","delay","IS_TOUCH_SUPPORTED","touchStartFired","rect","clickX","clickY","size","x","y","isRippleUnneeded","e","findUpClassName","findUpAsChild","touchEnd","liteMode","Button","className","options","button","i18n","textToSvgURL","text","blob","resolve","reader","bytesCmp","bytes1","bytes2","len","i"],"mappings":"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"}